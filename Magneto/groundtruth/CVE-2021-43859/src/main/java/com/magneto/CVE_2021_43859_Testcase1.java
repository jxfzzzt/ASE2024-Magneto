package com.magneto;

import com.thoughtworks.xstream.XStream;
import org.junit.Test;
import java.util.Hashtable;
import java.util.Map;
import static org.junit.Assert.assertEquals;
import static org.junit.Assert.fail;

public class CVE_2021_43859_Testcase1 {

    @Test(timeout = 60000)
    public void testDoSAttackWithHashtable() {
        final Map map = new Hashtable();
        Map m1 = map;
        Map m2 = new Hashtable();
        for (int i = 0; i < 100; i++) {
            final Map t1 = new Hashtable();
            final Map t2 = new Hashtable();
            t1.put("a", "b");
            t2.put("c", "d");
            m1.put(t1, t2);
            m1.put(t2, t1);
            m2.put(t2, t1);
            m2.put(t1, t2);
            m1 = t1;
            m2 = t2;
        }
        XStream xstream = new XStream();
        final String xml = xstream.toXML(map);
        try {
            xstream.fromXML(xml);
            fail("the test fail");
        } catch (final Exception e) {
            validateThrow(e);
        }
    }

    public void validateThrow(Throwable e) {
        assertEquals("com.thoughtworks.xstream.security.InputManipulationException", e.getClass().getName());
    }
}
